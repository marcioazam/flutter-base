name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  FLUTTER_VERSION: '3.38.0'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze & Format
    runs-on: ubuntu-latest
    outputs:
      analysis-result: ${{ steps.analyze.outcome }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Check formatting
        id: format
        run: dart format --set-exit-if-changed .

      - name: Analyze code
        id: analyze
        run: flutter analyze --fatal-infos

      - name: Post Analysis Summary
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const formatResult = '${{ steps.format.outcome }}';
            const analyzeResult = '${{ steps.analyze.outcome }}';
            const icon = (formatResult === 'success' && analyzeResult === 'success') ? '✅' : '❌';
            
            const body = `## ${icon} Code Analysis Results
            
            | Check | Status |
            |-------|--------|
            | Format | ${formatResult === 'success' ? '✅ Passed' : '❌ Failed'} |
            | Analyze | ${analyzeResult === 'success' ? '✅ Passed' : '❌ Failed'} |
            
            ${formatResult !== 'success' ? '> Run `dart format .` to fix formatting issues' : ''}
            ${analyzeResult !== 'success' ? '> Check the workflow logs for analysis errors' : ''}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: analyze
    outputs:
      coverage: ${{ steps.coverage.outputs.coverage }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Run tests with coverage
        run: flutter test --coverage --reporter=github

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage threshold
        id: coverage
        run: |
          if [ -f coverage/lcov.info ]; then
            COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//' || echo "0")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "Coverage: $COVERAGE%"
            if [ -n "$COVERAGE" ]; then
              THRESHOLD=80
              if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
                echo "::error::Coverage $COVERAGE% is below threshold of $THRESHOLD%"
                exit 1
              fi
            fi
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
            echo "::warning::No coverage file found"
          fi

      - name: Post Test Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}' || '0';
            const testResult = '${{ job.status }}';
            const icon = testResult === 'success' ? '✅' : '❌';
            
            const body = `## ${icon} Test Results
            
            | Metric | Value |
            |--------|-------|
            | Coverage | ${coverage}% |
            | Threshold | 80% |
            | Status | ${testResult === 'success' ? '✅ Passed' : '❌ Failed'} |
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Build Web
        run: flutter build web --release

      - name: Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 7

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Build APK
        run: flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [analyze, test, build-web, build-android]
    if: failure()
    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "CI Pipeline Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "CI Pipeline Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Repository:*\n${{ github.repository }}"},
                    {"type": "mrkdwn", "text": "*Branch:*\n${{ github.ref_name }}"},
                    {"type": "mrkdwn", "text": "*Commit:*\n${{ github.sha }}"},
                    {"type": "mrkdwn", "text": "*Author:*\n${{ github.actor }}"}
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "View Run"},
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true
